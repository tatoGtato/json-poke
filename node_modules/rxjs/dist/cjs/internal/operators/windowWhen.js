"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.windowWhen = void 0;
const Subscriber_1 = require("../Subscriber");
const Observable_1 = require("../Observable");
const Subject_1 = require("../Subject");
const from_1 = require("../observable/from");
const noop_1 = require("../util/noop");
function windowWhen(closingSelector) {
    return (source) => new Observable_1.Observable((destination) => {
        let window;
        let closingSubscriber;
        const handleError = (err) => {
            window.error(err);
            destination.error(err);
        };
        const openWindow = () => {
            closingSubscriber?.unsubscribe();
            window?.complete();
            window = new Subject_1.Subject();
            destination.next(window.asObservable());
            let closingNotifier;
            try {
                closingNotifier = (0, from_1.from)(closingSelector());
            }
            catch (err) {
                handleError(err);
                return;
            }
            closingNotifier.subscribe((closingSubscriber = (0, Subscriber_1.operate)({
                destination,
                next: openWindow,
                error: handleError,
                complete: noop_1.noop,
            })));
        };
        openWindow();
        source.subscribe((0, Subscriber_1.operate)({
            destination,
            next: (value) => window.next(value),
            error: handleError,
            complete: () => {
                window.complete();
                destination.complete();
            },
            finalize: () => {
                closingSubscriber?.unsubscribe();
                window = null;
            },
        }));
    });
}
exports.windowWhen = windowWhen;
//# sourceMappingURL=windowWhen.js.map